# REST API 设计标准

## 1 摘要

本文档参照微软, 阿里等公司的API规范并作了一些改动以适应本公司的项目, 用以提供一致的设计准则, 使API使用起来简单直观.

本文档建立了REST API应该遵循的准则, 以便一致地开发RESTful接口.

## 2 目录

- [REST API 设计标准](#rest-api-设计标准)
  - [1 摘要](#1-摘要)
  - [2 目录](#2-目录)
  - [3 开始之前](#3-开始之前)
  - [4 URL设计](#4-url设计)
    - [4.1 URL准则](#41-url准则)
    - [4.2 URL长度](#42-url长度)
    - [4.3 URL结构](#43-url结构)
  - [5 请求与响应](#5-请求与响应)
    - [5.1 HTTP方法](#51-http方法)
      - [5.1.1 POST](#511-post)
      - [5.1.2 PATCH](#512-patch)
    - [5.2 HTTP状态码](#52-http状态码)
    - [5.3 HTTP消息头](#53-http消息头)
      - [5.3.1 标准请求头](#531-标准请求头)
      - [5.3.2 标准响应头](#532-标准响应头)
    - [5.4 响应体](#54-响应体)
      - [5.4.1 成功响应](#541-成功响应)
      - [5.4.2 错误响应](#542-错误响应)
      - [5.4.3 故障响应](#543-故障响应)
  - [6 客户端指导规则](#6-客户端指导规则)
    - [6.1 忽略原则](#61-忽略原则)
    - [6.2 变量排序](#62-变量排序)
    - [6.3 无声失效原则](#63-无声失效原则)
    - [6.4 参数格式](#64-参数格式)
    - [6.5 响应处理](#65-响应处理)
  - [7 版本控制](#7-版本控制)
    - [7.1 版本格式](#71-版本格式)
    - [7.2 重大更改](#72-重大更改)
  - [8 备注](#8-备注)

## 3 开始之前

除非你对HTTP/1.1语义和RESTful风格有很清晰的认识, 否则建议首先阅读这些内容.

* [Wikipedia上的REST](https://zh.wikipedia.org/wiki/表现层状态转换) -维基百科上关于REST的核心概念与思想的介绍.
* [RFC 7231](https://tools.ietf.org/html/rfc7231) -定义HTTP/1.1语义的规范, 并被视为权威资源.
* [RESTful架构详解](https://www.runoob.com/w3cnote/restful-architecture.html) -菜鸟教程上的RESTful架构详解

## 4 URL设计

### 4.1 URL准则

人类应该能够轻松地读取和构造url.

结构良好的URL的示例是:

```
https://api.contoso.com/v1.0/people/jdoe@contoso.com/inbox
```

### 4.2 URL长度

API本身尽可能不要超过100个字符; 携带查询参数时, 尽可能不要超过255个字符.

### 4.3 URL结构

当URL代表资源时, 建议采取RESTful风格的URL, 如:

```
https://api.contoso.com/v1.0/articles
```

使用复数名词代表一个集合, 比如`GET /articles`

对于某个资源, 除了第一或第二级之外, 尽量使用查询字符串, 尽量使URL简短, 利于扩展且语义明确, 如: 

```
https://api.contoso.com/v1.0/article?id=123456
```

**对于部分无法代表资源的API请求, URL结构无须强制采取RESTful风格**

## 5 请求与响应

### 5.1 HTTP方法

客户端必须尽可能使用正确的HTTP动词来执行操作, 并且必须考虑是否支持此操作的幂等性. HTTP方法通常称为HTTP动词.

方法|描述|是否幂等
-|-|-
GET|返回对象的当前值|是
PUT|在适用时替换对象, 或创建命名对象|是
DELETE|删除对象|是
POST|根据提供的数据创建一个新对象, 或者提交一个操作|否
PATCH|更新对象部分应用|否

POST, PUT/PATCH, GET, DELETE即对应了CURD;

> 幂等性原本是数学中的含义, 表达式的是N次变换与1次变换的结果相同.  
而HTTP中的幂等性是指调用某个方法1次或N次对资源产生的影响结果都是相同的, 需要特别注意的是: 这里幂等性指的是对资源产生的影响结果, 而不是调用HTTP方法的返回结果.  
举个例子, HTTP中的GET方法是查询资源信息, 不会对资源产生影响, 所以它是符合幂等性的, 但是每次调用GET方法返回的结果有可能不同 (可能资源的某个属性在调用GET方法之前已经被其他方法修改了).

#### 5.1.1 POST

POST请求通常用于表单提交和资源创建. 在部分情况下, POST请求可以支持Location响应头.

例如, 假设一个服务允许创建并命名托管服务器:

```
POST http://api.contoso.com/account1/servers
```

当携带Location响应头时, 响应应该是这样的:

```
201 Created
Location: http://api.contoso.com/account1/servers/server321
```

#### 5.1.2 PATCH

PATCH已被IETF标准化为用于增量更新现有对象的方法 (参见[RFC 5789](#http://tools.ietf.org/html/rfc5789)).

### 5.2 HTTP状态码

> HTTP状态码 (英语: HTTP Status Code) 是用以表示网页服务器超文本传输协议响应状态的3位数字代码.它由 RFC 2616 规范定义的, 并得到 RFC 2518, RFC 2817, RFC 2295, RFC 2774 与 RFC 4918 等规范扩展. 所有状态码的第一个数字代表了响应的五种状态之一. 所示的消息短语是典型的, 但是可以提供任何可读取的替代方案, 除非另有说明, 状态码是HTTP/1.1标准 (RFC 7231) 的一部分.

常用的状态码在下面标识.

**2xx**

* `200 OK` -请求已成功, 请求所希望的响应头或数据体将随此响应返回. 实际的响应将取决于所使用的请求方法. 在GET请求中, 响应将包含与请求的资源相对应的实体. 在POST请求中, 响应将包含描述或操作结果的实体.
* `201 Created` -请求已经被实现, 而且有一个新的资源已经依据请求的需要而创建. 此状态码需配合POST请求和Location响应头, 资源的URI已经随Location头信息返回.

**4xx**

* `400 Bad Request` -由于明显的客户端错误 (例如, 格式错误的请求语法, 太大的大小, 无效的请求消息或欺骗性路由请求), 服务器不能或不会处理该请求.
* `401 Unauthorized` -401语义即 "未认证", 即用户没有必要的凭据. 该状态码表示当前请求需要用户验证. 客户端可以重复提交一个包含恰当的Authorization头信息的请求.
* `415 Unsupported Media Type` -对于当前请求的方法和所请求的资源, 请求中提交的互联网媒体类型并不是服务器中所支持的格式, 因此请求被拒绝. 例如, 客户端将图像上传格式为svg, 但服务器要求图像使用上传格式为jpg.
* `418 I'm a teapot` -在RFC 2324中定义, 当一个控制茶壶的API收到POST指令要求其煮咖啡时应当回传此错误.
* `429 Too Many Requests` -用户在给定的时间内发送了太多的请求.

**5xx**

* `500 Internal Server Error` -通用错误消息, 服务器遇到了一个未曾预料的状况, 导致了它无法完成对请求的处理.

### 5.3 HTTP消息头

#### 5.3.1 标准请求头

请求头|类型|描述
-|-|-
Authorization|String|请求携带的用户Token, 用于鉴权.
Content-Type|Content type|* `application/json` -除非另有说明, 否则所有的请求一律采用此类型. <br> * `multipart/form-data` -当且仅当文件上传时, 使用此类型.

#### 5.3.2 标准响应头

响应头|类型|描述
-|-|-
Content-Type|Content type|除非另有说明, 否则值为`application/json`.
Location|String|若HTTP状态码为`201 Created`, 则额外包含此响应头, 值为资源的URL

### 5.4 响应体

响应体的格式对应HTTP状态码, **2xx**代表成功响应, **4xx**代表错误响应, **5xx**代表故障响应.

#### 5.4.1 成功响应

成功的响应必须包含名称/值对, 名称为"code", "message"和"data".

名称|类型|是否必须|描述
-|-|-|-
`code`|String(enumerated)|是|自定义业务状态码, 长度为4位
`message`|String|是|使用自然语言描述的消息
`data`|Object|是|接口返回的详细信息的JSON对象

**示例**

```json
HTTP 1.1 200 OK

{
    "code": 1000,
    "messgae": "验证码发送成功",
    "data": {
        "timeout": 300
    }
}
```

#### 5.4.2 错误响应

错误响应必须是单个JSON对象. 这个对象必须有一个名为“错误”的名称/值对. 该值必须是JSON对象.

这个对象必须包含名称/值对, 名称为"code"和"message", 并且可以包含名称/值对"details".

**错误响应: Object**

名称|类型|是否必须|描述
-|-|-|-
`error`|Error|是|错误响应的对象

**Error: Object**

名称|类型|是否必须|描述
-|-|-|-
`code`|String(enumerated)|是|自定义错误码, 在HTTP状态码的基础上扩展至5位
`message`|String|是|使用自然语言描述的错误消息
`details`|Object|否|详细描述错误信息的JSON对象

**示例**

```json
HTTP 1.1 400 Bad Request

{
  "error": {
    "code": "40001",
    "message": "参数为空或不存在",
    "details": []
  }
}
```

#### 5.4.3 故障响应

**示例**

```json
HTTP 1.1 500 Internal Server Error

{
  "error": {
    "code": "500",
    "message": "RuntimeError"
  }
}
```

## 6 客户端指导规则

为确保客户端更好的接入REST服务, 客户端应遵循以下最佳实践:

### 6.1 忽略原则

对于松散耦合的客户端调用, 在调用之前不知道数据的确切定义和格式, 如果服务器没用返回客户端预期的内容, 客户端必须安全地忽略它.

在服务迭代的过程中, 有些服务 (接口) 可能在不更改版本号的情况下向响应添加字段. 此类服务必须在其文档中注明, 客户端必须忽略这些未知字段.

### 6.2 变量排序

客户端处理响应数据时一定不能依赖服务端JSON响应数据字段的顺序. 例如, 当服务器返回的JSON对象中的字段顺序发生变化, 客户端应当能够正确进行解析处理.

当服务端支持时, 客户端可以请求以特定的顺序返回数据.

### 6.3 无声失效原则

当客户端请求带可选功能参数的服务时 (例如带可选的头部信息),必须对服务端的返回格式有一定兼容性, 例如分页数, 排序等自定义参数的支持和返回格式的兼容.

### 6.4 参数格式

请求和响应的参数格式一律遵守camelCased.

### 6.5 响应处理

响应处理须参照HTTP响应的状态码.

* **2xx**的状态码代表接口执行成功, 但不代表业务执行成功, 例如: 删除一个不存在的资源. 在大部分情况下, 客户端仍需要判断响应体中的`code`.
* 通常情况下客户端仅须全局处理`400 Bad Request`和`429 Too Many Requests`, 打印`message`中的内容即可. `415 Unsupported Media Type`较少应用, 建议单独处理.
* 当服务端返回`401 Unauthorized`时, 客户端应做处理, 例如跳转回登录页面; 在微信小程序的业务场景中, 还需要根据`code`判断是用户token过期还是sessionKey过期, 以调用不同的登录接口.
* 对于**5xx**的状态码, 建议直接打印"远程服务器异常"或是用户友好的信息.

## 7 版本控制

当某个项目满足长达2个月以上的持续更新或包含移动APP时, 其API必须支持显式版本控制.

### 7.1 版本格式

将版本控制嵌入在请求URL的路径中, 位于服务根目录的末尾, 例如: `https://api.contoso.com/v1.0/products/users`

### 7.2 重大更改

对API合约的更改被视为重大更改; 影响API向后兼容性的更改是一项重大更改. 在此情况下, 需要更改版本号.

重大更改的定义：

* 删除或重命名API或API参数
* 现有API的行为更改
* 错误代码和故障合约的变更
* 任何违反最小惊讶原则的东西

## 8 备注
